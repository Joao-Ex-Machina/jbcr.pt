{{ define "main" }}
<h1>{{ .Title }}</h1>

<div class="page-description">
  {{ .Content }}
</div>

<!-- Filter controls -->
<div class="filter-controls">
  <!-- Tag filters -->
  <div class="filter-group">
    <label>Tags:</label>
    <div id="tag-filters">
      <button data-tag="all" class="active">All</button>
      {{ $allTags := slice }}
      {{ range site.Data.photos.analog }}
        {{ range .tags }}
          {{ if not (in $allTags .) }}
            {{ $allTags = $allTags | append . }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{ range $allTags }}
        <button data-tag="{{ . }}">{{ . }}</button>
      {{ end }}
    </div>
  </div>

  <!-- Album filters -->
  <div class="filter-group">
    <label>Locations:</label>
    <div id="album-filters">
      <button data-album="all" class="active">All</button>
      {{ $allAlbums := slice }}
      {{ range site.Data.photos.analog }}
        {{ if not (in $allAlbums .album) }}
          {{ $allAlbums = $allAlbums | append .album }}
        {{ end }}
      {{ end }}
      {{ range $allAlbums }}
        <button data-album="{{ . }}">{{ . }}</button>
      {{ end }}
    </div>
  </div>
</div>

<!-- Gallery grid -->
<div class="masonry-gallery" id="photo-gallery">
  {{ range site.Data.photos.analog }}
    <div class="masonry-item" 
         data-tags='{{ if .tags }}{{ delimit .tags " " }}{{ end }}' 
         data-album="{{ .album }}">
      <a href="/photos/analog/{{ .filename }}" class="glightbox" data-title='
        <div class="photo-info">
          <strong>{{ .title }}</strong><br>
          {{ .camera }} | {{ .film }} | {{ .album }} | {{ .date }}
        </div>
      '>
        <img src="/photos/analog/{{ .filename }}" alt="{{ .title }}" loading="lazy">
      </a>
    </div>
  {{ end }}
</div>

<!-- GLightbox CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

<script>
// Lightbox variable
let lightbox;

// Filter state
let activeTag = 'all';
let activeAlbum = 'all';

// Get all filter buttons and gallery items
const tagButtons = document.querySelectorAll('#tag-filters button');
const albumButtons = document.querySelectorAll('#album-filters button');
const items = document.querySelectorAll('.masonry-item');

// Function to initialize/reinitialize lightbox
function initializeLightbox() {
  // Destroy existing lightbox if it exists
  if (lightbox) {
    lightbox.destroy();
  }
  
  // Initialize lightbox only with visible images
  lightbox = GLightbox({ 
    selector: '.masonry-item:not([style*="display: none"]) .glightbox'
  });
}

// Function to apply filters
function applyFilters() {
  items.forEach(item => {
    const tags = item.dataset.tags ? item.dataset.tags.split(" ") : [];
    const album = item.dataset.album;
    
    const tagMatch = activeTag === 'all' || tags.includes(activeTag);
    const albumMatch = activeAlbum === 'all' || album === activeAlbum;
    
    item.style.display = (tagMatch && albumMatch) ? 'block' : 'none';
  });
  
  // Reinitialize lightbox with filtered images
  initializeLightbox();
}

// Tag filtering
tagButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    tagButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeTag = btn.dataset.tag;
    applyFilters();
  });
});

// Album filtering
albumButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    albumButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeAlbum = btn.dataset.album;
    applyFilters();
  });
});

// Initialize lightbox on page load
initializeLightbox();
</script>

<style>
/* Filter controls */
.filter-controls {
  margin-bottom: 24px;
  padding: 16px;
  border-radius: 8px;
}

.filter-group {
  margin-bottom: 16px;
}

.filter-group:last-child {
  margin-bottom: 0;
}

.filter-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: #333;
}

/* Filter buttons */
#tag-filters, #album-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

#tag-filters button, #album-filters button {
  padding: 8px 16px;
  border: 1px solid #ddd;
  background: #fff;
  cursor: pointer;
  border-radius: 6px;
  font-size: 14px;
  transition: all 0.2s ease;
}

#tag-filters button:hover, #album-filters button:hover {
  background: #e9ecef;
  border-color: #adb5bd;
}

#tag-filters button.active {
  background: #e53e3e;
  color: white;
  border-color: #e53e3e;
}

#album-filters button.active {
  background: #28a745;
  color: white;
  border-color: #28a745;
}

/* Masonry */
.masonry-gallery {
  column-count: 3;
  column-gap: 16px;
}

@media (max-width: 768px) {
  .masonry-gallery {
    column-count: 2;
  }
}

@media (max-width: 480px) {
  .masonry-gallery {
    column-count: 1;
  }
  
  #tag-filters, #album-filters {
    justify-content: center;
  }
}

.masonry-item {
  break-inside: avoid;
  margin-bottom: 16px;
}

.masonry-item img {
  width: 100%;
  height: auto;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.3s ease;
}

.masonry-item img:hover {
  transform: scale(1.02);
}

/* Lightbox styling */
.glightbox-clean .gdesc-inner {
  padding: 2px 10px;
}

.photo-info {
  font-size: 0.9rem;
  line-height: 1.2;
  color: #eee;
}
</style>

{{ end }}
